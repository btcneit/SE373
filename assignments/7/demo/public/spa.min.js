class SPA{constructor(route){this.content=document.querySelector("div.spa-content");this.loading=document.querySelector("div.spa-loading").classList;this.Model=new Model;this.View=new View;this.controller=new Controller(this.Model);this.checkedRegex=/(radio|checkbox)/i;window.addEventListener("hashchange",()=>{this.loadingStart();let page=this.Model.page;document.body.id=page;this.controller[page]().then(()=>{return this.renderContent(this.View[page])}).then(()=>{this.bindModelText().parseEvents().twoWayInputBind().parseClassState().cleanNavLinks().loadingEnd()}).catch(err=>{console.error(err);this.renderContent(window.Promise.resolve(this.Model.escapeHTML(err))).then(()=>{this.cleanNavLinks().loadingEnd()})})});if(!window.location.hash&&typeof route==="string"){window.location.hash=route}window.dispatchEvent(new HashChangeEvent("hashchange"))}loadingStart(){this.loading.add("visible");return this}loadingEnd(){this.loading.remove("visible");window.dispatchEvent(new CustomEvent("spaRouteReady"));return this}renderContent(page){return page.then(html=>{this.content.innerHTML=html;return this})}update(evt,funcName){return this.Model[funcName](evt).then(()=>{return this.bindModelText().parseEvents().twoWayInputBind().parseClassState()})}cleanNavLinks(){let links=[].slice.call(document.querySelector("nav").querySelectorAll("a"));links.forEach(link=>{link.setAttribute("href",`${window.location.origin}${link.hash}`)});return this}parseClassState(){let contents=[].slice.call(this.content.querySelectorAll("*[data-bind-class]"));contents.forEach(domElem=>{let css={};const bindClass=domElem.dataset.bindClass.replace(/'/g,'"');try{css=window.JSON.parse(bindClass)}catch(e){console.error(e);css={}}Object.entries(css).forEach(([className,condition])=>{const negation=condition.indexOf("!")>-1;condition=condition.replace(/!|\s/g,"");let add=this.Model[condition];if(negation)add=!add;domElem.classList[add?"add":"remove"](className)})});return this}parseEvents(){let contents=[].slice.call(this.content.querySelectorAll("*[data-bind-event]"));contents.forEach(domElem=>{const[evtName,funcName]=domElem.dataset.bindEvent.split(":");domElem.addEventListener(evtName,evt=>{return this.update(evt,funcName)});delete domElem.dataset.bindEvent});return this}twoWayInputBind(){let inputs=[].slice.call(this.content.querySelectorAll("input, select, textarea"));inputs.filter(field=>field.dataset.bindInput!=="false").filter(field=>field.name||field.dataset.hasOwnProperty("bindModel")).forEach(domElem=>{domElem.dataset.bindInput="false";const evtName=this.checkedRegex.test(domElem.type)?"change":"input";domElem.addEventListener(evtName,evt=>{const target=evt.target;const property=target.name||target.dataset.bindModel;const value=evt.target.type==="checkbox"?target.checked:target.value;this.Model.dataBindModel={[property]:value}})});return this}bindModelText(){let contents=[].slice.call(this.content.querySelectorAll("*[data-bind-model], input, select, textarea"));const obj=this.Model.dataBindModel;contents.filter(domElem=>!domElem.dataset.hasOwnProperty("bindReady")).filter(domElem=>domElem.name||domElem.dataset.hasOwnProperty("bindModel")).forEach(domElem=>{const property=domElem.name||domElem.dataset.bindModel;if(!domElem.dataset.hasOwnProperty("bindModel"))domElem.dataset.bindModel=property;if(!domElem.dataset.hasOwnProperty("bindReady"))domElem.dataset.bindReady="true";const selector=`*[data-bind-model="${property}"]`;let val,safeVal;const useSafeHTML=domElem.dataset.hasOwnProperty("bindSafe");if(obj.hasOwnProperty(property)&&obj[property]!==undefined){val=obj[property];safeVal=this.Model.escapeHTML(val);if(domElem.type==="radio")domElem.checked=domElem.value===val;else if(domElem.type==="checkbox")domElem.checked=val;else if("value"in domElem)domElem.value=useSafeHTML?safeVal:val;else if("innerHTML"in domElem)domElem.innerHTML=useSafeHTML?safeVal:val}if(!domElem.matches("input, select, textarea"))domElem.dataset.bindDisplay=domElem.innerHTML.length?"visible":"hidden";if(domElem.dataset.hasOwnProperty("bindCallback"))this.update(domElem,domElem.dataset.bindCallback);Object.defineProperty(obj,property,{get:()=>{return val},set:newValue=>{let elems=[].slice.call(this.content.querySelectorAll(selector));val=newValue;safeVal=this.Model.escapeHTML(val);elems.forEach(elem=>{const useSafeHTML=elem.dataset.hasOwnProperty("bindSafe");if(elem.type==="radio")elem.checked=elem.value===val;else if(elem.type==="checkbox")elem.checked=val;else if("value"in elem)elem.value=useSafeHTML?safeVal:val;else if("innerHTML"in elem)elem.innerHTML=useSafeHTML?safeVal:val;if(!elem.matches("input, select, textarea"))elem.dataset.bindDisplay=elem.innerHTML.length?"visible":"hidden";if(elem.dataset.hasOwnProperty("bindCallback"))this.update(elem,elem.dataset.bindCallback)});this.parseClassState()},configurable:true})});return this}}class BaseModel{constructor(){this.APIS={};this._Model={};Object.getOwnPropertyNames(Object.getPrototypeOf(new Controller)).filter(page=>page!=="constructor").forEach(page=>{this._Model[page]={}});this.http={get:url=>{return this.httpFetch(url,null,"GET").then(response=>response.json())},post:(url,data)=>{return this.httpFetch(url,data,"POST").then(response=>response.json())},put:(url,data)=>{return this.httpFetch(url,data,"PUT").then(response=>response.json())},delete:url=>{return this.httpFetch(url,null,"DELETE")}}}get dataBindModel(){return this._Model[this.page]}set dataBindModel(model){Object.assign(this._Model[this.page],model);return this}clearDataBindModel(){this._Model[this.page]={};return this}get page(){return window.location.hash.slice(1).split("?")[0]}escapeHTML(html){let div=document.createElement("div");div.appendChild(document.createTextNode(html));return div.innerHTML}httpFetch(url,data,verb){let myHeaders=new Headers;myHeaders.set("Content-Type","application/json");let myInit={method:verb,headers:myHeaders,mode:"cors",cache:"default"};if(data){myInit.body=JSON.stringify(data)}const myRequest=new Request(url,myInit);return fetch(myRequest).then(response=>{if(!response.ok)throw Error(response.statusText);return response})}generateUrlParams(params={}){return`?${Object.keys(params).map(k=>[k,params[k]].map(window.encodeURIComponent).join("=")).join("&")}`}urlParams(){return new URLSearchParams(window.location.search)}}class Components{static emplTable(data){if(!Array.isArray(data))return Promise.resolve("");return Promise.resolve(`${data.map(row=>`<tr>\n                        <td>${row._id}</td>\n                        <td>${row.firstName+" "+row.lastName}</td>\n                        <td>${row.department}</td>\n                        <td>${row.jobTitle}</td>\n                        <td>${row.salary}</td>\n                        <td>${row.startDate.substring(0,row.startDate.indexOf("T"))}</td>\n                        <td><button data-id="${row._id}" data-bind-event="click:goToUpdatePage" class="update">Update</button></td>\n                        <td><button data-id="${row._id}" data-bind-event="click:deleteEmpl" class="delete">Delete</button></td>\n                    </tr>`).join("")}`)}}class Controller{constructor(model){this.Model=model}home(){return this.Model.getEmplList()}add(){this.Model.clearDataBindModel();return window.Promise.resolve()}update(){return this.Model.updatePageLoad()}}class Model extends BaseModel{constructor(){super();this.APIS={Empl:"http://localhost:3001/api/v1/employees/"}}getEmplList(){return this.http.get(this.APIS.Empl).then(data=>{return Components.emplTable(data).then(html=>{return this.dataBindModel.emplTable=html})})}deleteEmpl(evt){const url=`${this.APIS.Empl}${evt.target.dataset.id}`;return this.http.delete(url).then(()=>{return this.dataBindModel.deleteResultMsg="Todo Deleted"}).catch(err=>{return this.dataBindModel.deleteResultMsg="Todo was NOT Deleted"}).then(()=>{return this.getEmplList()})}saveEmpl(evt){let form=evt.target.form;if(!form.checkValidity()){this.dataBindModel.saveResultMsg="All fields are required";return Promise.resolve()}const data={firstname:this.dataBindModel.fname,lastname:this.dataBindModel.lname,department:this.dataBindModel.department,jobtitle:this.dataBindModel.jobTitle,salary:this.dataBindModel.salary,startdate:this.dataBindModel.startDate};return this.http.post(this.APIS.Empl,data).then(data=>{this.dataBindModel.saveResultMsg="Todo Saved";return data}).catch(err=>{this.dataBindModel.saveResultMsg="Todo was NOT Saved";return err})}goToUpdatePage(evt){this.redirect("update",{id:evt.target.dataset.id});return Promise.resolve()}updatePageLoad(){const url=`${this.APIS.Empl}${this.urlParams().get("id")}`;return this.http.get(url).then(data=>{this.dataBindModel={fname:data.firstName,lname:data.lastName,jobTitle:data.jobTitle,salary:data.salary,startDate:data.startDate.substring(0,data.startDate.indexOf("T")),department:data.department,id:data._id};return data})}updateEmpl(evt){let form=evt.target.form;if(!form.checkValidity()){this.dataBindModel.updateResultMsg="All fields are required";return Promise.resolve()}const data={firstname:this.dataBindModel.fname,lastname:this.dataBindModel.lname,department:this.dataBindModel.department,jobtitle:this.dataBindModel.jobTitle,salary:this.dataBindModel.salary,startdate:this.dataBindModel.startDate};console.log(this.dataBindModel.id);const url=`${this.APIS.Empl}${this.dataBindModel.id}`;return this.http.put(url,data).then(data=>{this.dataBindModel.updateResultMsg="Todo updated";return data}).catch(err=>{this.dataBindModel.updateResultMsg="Todo was NOT updated";return err})}get isDeleted(){const msg=this.dataBindModel.deleteResultMsg;return msg&&msg.toLowerCase().indexOf("not")===-1}get isAdded(){const msg=this.dataBindModel.saveResultMsg;return msg&&msg.toLowerCase().indexOf("not")===-1&&msg.toLowerCase().indexOf("required")===-1}get isUpdated(){const msg=this.dataBindModel.updateResultMsg;return msg&&msg.toLowerCase().indexOf("not")===-1&&msg.toLowerCase().indexOf("required")===-1}}class View{get home(){return Promise.resolve(`<h1 class="content-title">List all Employees</h1>\n                <p data-bind-model="deleteResultMsg" data-bind-safe data-bind-class="{'is-success': 'isDeleted', 'is-danger': '!isDeleted' }" class="notification is-spaced"></p>              \n                <table class="content-table">\n                  <thead>\n                    <tr>\n                        <th>ID</th>\n                        <th>Name</th>\n                        <th>Department</th>\n                        <th>Job Title</th>\n                        <th>Salary</th>\n                        <th>Start Date</th>\n                        <th></th>\n                        <th></th>\n                    </tr>\n                  </thead>\n                  <tbody data-bind-model="emplTable"></tbody>\n              </table>`)}get add(){return Promise.resolve(` <h1 class="content-title">Add New Todo</h1>\n                <form data-no-submit class="content-form">\n                    <p data-bind-model="saveResultMsg" data-bind-safe data-bind-class="{'is-success': 'isAdded', 'is-danger': '!isAdded' }" class="notification"></p>\n                    <div class="content-form-item">\n                        <label class="label">First Name: </label>\n                        <input type="text" name="fname" class="input" required />\n                    </div>\n                    <div class="content-form-item">\n                        <label class="label">Last Name: </label>\n                        <input type="text" name="lname" class="input" required />\n                    </div>\n                    <div class="content-form-item">\n                        <label class="label">Department</label>\n                        <select name="department" required>\n                            <option value="" selected disabled>Please Select a Department</option>\n                            <option value="IT">IT</option>\n                            <option value="HR">HR</option>\n                            <option value="SM">SM</option>\n                        </select>\n                    </div>\n                    <div class="content-form-item">\n                        <label class="label">Job Title: </label>\n                        <input type="text" name="jobTitle" class="input" required />\n                    </div>\n                    <div class="content-form-item">\n                        <label class="label">Salary: </label>\n                        <input type="number" name="salary" class="input" required />\n                    </div>\n                    <div class="content-form-item">\n                        <label class="label">Start Date: </label>\n                        <input type="date" name="startDate" class="input" required />\n                    </div>\n                    <div class="content-form-item"> \n                        <input type="reset" value="Reset" />\n                        <input type="button" value="Submit" class="button is-link" data-bind-event="click:saveEmpl" /> \n                    </div>\n                </form>`)}get update(){return Promise.resolve(`<section>\n                    <div>\n                        <h1 class="title">Update Todo ID <span data-bind-model="id" class="has-text-warning"></span></h1>\n                    </div>\n                </section>\n                <form data-no-submit>\n                    <p data-bind-model="updateResultMsg" data-bind-safe data-bind-class="{'is-success': 'isUpdated', 'is-danger': '!isUpdated' }" class="notification is-spaced"></p>\n                    <div>\n                        <label class="label">First Name: </label>\n                        <input type="text" name="fname" class="input" required />\n                    </div>\n                    <div>\n                        <label class="label">Last Name: </label>\n                        <input type="text" name="lname" class="input" required />\n                    </div>\n                    <div>\n                        <label class="label">Department</label>\n                        <select name="department" required>\n                            <option value="" selected disabled>Please Select a Department</option>\n                            <option value="IT">IT</option>\n                            <option value="HR">HR</option>\n                            <option value="SM">SM</option>\n                        </select>\n                    </div>\n                    <div>\n                        <label class="label">Job Title: </label>\n                        <input type="text" name="jobTitle" class="input" required />\n                    </div>\n                    <div>\n                        <label class="label">Salary: </label>\n                        <input type="number" name="salary" class="input" required />\n                    </div>\n                    <div>\n                        <label class="label">Start Date: </label>\n                        <input type="date" name="startDate" class="input" required />\n                    </div>\n                    <div class="field"> \n                        <input type="reset" value="Reset" />\n                        <input type="button" value="Submit" class="button is-link" data-bind-event="click:updateEmpl" /> \n                    </div>\n                </form>`)}}Object.assign(View.prototype,{fetchHTML(file){return fetch(file).then(response=>{if(!response.ok)throw Error(response.statusText);return response.text()}).then(text=>{let doc=(new DOMParser).parseFromString(text,"text/html");return doc.body.innerHTML.toString()}).catch(err=>{console.error(err);return"<p>Could not fetch file: ${file}</p>"})}});NodeList.prototype.forEach=Array.prototype.forEach;Object.assign(BaseModel.prototype,{formatNumber(number){return(new Intl.NumberFormat).format(number)},formatDate(date){const options={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"};return new Date(date).toLocaleDateString("en-US",options)}});window.addEventListener("spaRouteReady",()=>{[].slice.call(document.querySelectorAll("*[data-custom-no-submit]")).forEach(form=>{form.addEventListener("submit",event=>event.preventDefault())})});Object.assign(BaseModel.prototype,{redirect(route=window.location.hash.slice(1).split("?")[0],params={}){const query=this.generateUrlParams(params);window.location.assign(`${query}#${route}`)}});